name: OpenClaw Daily Report (Elite Edition)

on:
  workflow_dispatch:
  schedule:
    - cron: '0 1 * * *'   # åŒ—äº¬æ—¶é—´ 09:00
    - cron: '30 13 * * *' # åŒ—äº¬æ—¶é—´ 21:30

jobs:
  daily_job:
    runs-on: ubuntu-latest
    steps:
      - name: Run AI Tasks
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          SERVERCHAN_SENDKEY: ${{ secrets.SERVERCHAN_SENDKEY }}
        run: |
          python3 -c "
          import urllib.parse, urllib.request, json, os, datetime, re

          now_bj = datetime.datetime.utcnow() + datetime.timedelta(hours=8)
          hour = now_bj.hour

          def get_ai_res(prompt):
              data = json.dumps({'model': 'deepseek-chat', 'messages': [{'role': 'user', 'content': prompt}]}).encode()
              req = urllib.request.Request('https://api.deepseek.com/chat/completions', data=data, headers={'Content-Type': 'application/json', 'Authorization': f'Bearer {os.environ[\"OPENAI_API_KEY\"]}'})
              with urllib.request.urlopen(req) as f:
                  return json.loads(f.read().decode())['choices'][0]['message']['content']

          # --- æ—©ä¸Šé€»è¾‘ ---
          if 7 <= hour <= 12:
              txt1 = get_ai_res('ç²¾é€‰ä¸€å¥ã€Šç»´ç‰¹æ ¹æ–¯å¦ä¼ ã€‹è¯­å½•å¹¶ç®€çŸ­è§£è¯»ï¼Œ80å­—å†…ã€‚')
              txt2 = get_ai_res('ä½œä¸ºå°çº¢ä¹¦ä¸“å®¶ï¼Œæ€»ç»“3ä¸ªä»Šæ—¥çˆ†æ¬¾æ¡ˆä¾‹ï¼ˆæ ‡é¢˜+è´¦å·å+çˆ†ç‚¹ï¼‰ï¼Œ180å­—å†…ã€‚')
              title, msg = 'â˜€ï¸ æ—©å®‰Â·æ·±åº¦ç®€æŠ¥', f'**ã€ç»´ç‰¹æ ¹æ–¯å¦ Â· æ¯æ—¥ä¸€è¯­ã€‘**\n> {txt1}\n\n**ã€ğŸ”¥ å°çº¢ä¹¦æ·±åº¦æƒ…æŠ¥ã€‘**\n{txt2}'

          # --- æ™šä¸Šé€»è¾‘ (ç²¾è‹±æ±‡æŠ¥æ¨¡å¼) ---
          else:
              raw_news = ''
              try:
                  req = urllib.request.Request('https://top.baidu.com/board?tab=realtime', headers={'User-Agent': 'Mozilla/5.0'})
                  with urllib.request.urlopen(req) as r:
                      content = r.read().decode()
                      titles = re.findall(r'\"word\":\"(.*?)\"', content)
                      raw_news = 'ã€'.join(titles[:25])
              except:
                  raw_news = 'å…¨çƒèµ„è®¯æ­£åœ¨é«˜é¢‘æ³¢åŠ¨ä¸­...'

              prompt_news = f'''
              ä½ ç°åœ¨æ˜¯ OpenClaw é¦–å¸­æ”¿ç»è§‚å¯Ÿå‘˜ã€‚è¯·æ ¹æ®ä»Šæ—¥çƒ­ç‚¹ï¼š{raw_news}
              æ’°å†™ä¸€ä»½å¯¹æ ‡ä¸“ä¸šå†…å‚çš„æ–°é—»ç®€æŠ¥ã€‚
              
              è¦æ±‚æ ¼å¼å¦‚ä¸‹ï¼ˆä¸¥æ ¼éµå®ˆï¼‰ï¼š
              ğŸ“… **AI ç®€æŠ¥ï¼šå…¨çƒåŠ¨æ€ç²¾ç²¹ {now_bj.strftime('%m-%d')}**
              
              **1. ğŸŒ ã€å›½é™…è§†é‡ã€‘**
              (ç­›é€‰å›½é™…ã€å¤–äº¤æˆ–å®è§‚ç»æµè¶‹åŠ¿ï¼Œè¿›è¡Œ2æ¡ä»¥ä¸Šçš„æ·±åº¦æ¦‚æ‹¬ï¼Œæ¯æ¡åŒ…å«[è¿è¥è§†è§’/æ·±åº¦è§£è¯»])
              
              **2. ğŸ‡¨ğŸ‡³ ã€æ ¸å¿ƒè¦é—»ã€‘**
              (æ€»ç»“å›½å†…æ”¿ç­–ã€é‡è¦ä¼šè®®æˆ–é‡å¤§ç¤¾ä¼šåŠ¨å‘)
              
              **3. ğŸ“‰ ã€ç»æµä¸ç¤¾ä¼šã€‘**
              (ç»“åˆæ¶ˆè´¹ã€æ°‘ç”Ÿã€ç§‘æŠ€çƒ­ç‚¹ï¼Œç”¨ä¸“ä¸šè¯­å¢ƒå™è¿°)
              
              **4. ğŸ­ ã€AI å“²å­¦ç‚¹è¯„ã€‘**
              (ç”¨ç»´ç‰¹æ ¹æ–¯å¦æˆ–å­˜åœ¨ä¸»ä¹‰è§†è§’ï¼Œä¸€å¥è¯ç‚¹è¯„ä»Šæ—¥ä¸–ç›¸ï¼Œè¯­æ°”å†·å³»ä¸”å……æ»¡äººæ–‡å…³æ€€)
              
              æ³¨æ„ï¼š
              - é€‚å½“ä½¿ç”¨**åŠ ç²—**æ¥çªå‡ºé‡ç‚¹å…³é”®è¯ã€‚
              - å¢åŠ  Emoji ç¬¦å·æå‡ç¾æ„Ÿã€‚
              - æ€»å­—æ•°æ§åˆ¶åœ¨ 400 å­—å·¦å³ï¼Œä¿æŒæ’ç‰ˆç–æœ—ã€‚
              '''
              formatted_news = get_ai_res(prompt_news)
              title, msg = f'ğŸŒ™ æ™šå®‰ Â· æ·±åº¦æ±‡æŠ¥ ({now_bj.strftime('%m-%d')})', formatted_news

          params = urllib.parse.urlencode({'title': title, 'desp': msg})
          urllib.request.urlopen(f'https://sctapi.ftqq.com/{os.environ[\"SERVERCHAN_SENDKEY\"]}.send?{params}')
          "
