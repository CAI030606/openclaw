name: OpenClaw Elite Intelligence (Refined Classic)

on:
  workflow_dispatch:
  schedule:
    - cron: '10 1 * * *'   # æ—©æŠ¥ 09:10
    - cron: '40 13 * * *'  # æ™šæŠ¥ 21:40

jobs:
  daily_job:
    runs-on: ubuntu-latest
    steps:
      - name: Run AI Tasks
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          SERVERCHAN_SENDKEY: ${{ secrets.SERVERCHAN_SENDKEY }}
        run: |
          python3 -c "
          import urllib.parse, urllib.request, json, os, datetime, re

          now_bj = datetime.datetime.utcnow() + datetime.timedelta(hours=8)
          date_str = now_bj.strftime('%m-%d')
          utc_hour = datetime.datetime.utcnow().hour
          is_morning = (0 <= utc_hour <= 5)

          def get_ai_res(prompt):
              data = json.dumps({'model': 'deepseek-chat', 'messages': [{'role': 'user', 'content': prompt}]}).encode()
              req = urllib.request.Request('https://api.deepseek.com/chat/completions', data=data, headers={'Content-Type': 'application/json', 'Authorization': 'Bearer ' + os.environ['OPENAI_API_KEY']})
              with urllib.request.urlopen(req) as f:
                  return json.loads(f.read().decode())['choices'][0]['message']['content']

          # æŠ“å–é€»è¾‘ï¼šç»¼åˆçƒ­æœä½œä¸ºåˆ†æåº•æ–™
          raw_news = 'èµ„è®¯è·å–ä¸­...'
          try:
              req = urllib.request.Request('https://top.baidu.com/board?tab=realtime', headers={'User-Agent': 'Mozilla/5.0'})
              with urllib.request.urlopen(req) as r:
                  titles = re.findall(r'\"word\":\"(.*?)\"', r.read().decode())
                  raw_news = 'ã€'.join(titles[:25])
          except: pass

          if is_morning:
              # --- â˜€ï¸ æ—©æŠ¥ï¼šå“²å­¦ã€AIå‰å“¨ä¸æµé‡æ‹†è§£ ---
              prompt = f'ä½ ç°åœ¨æ˜¯é¦–å¸­å†…å®¹å®˜ã€‚è¯·åŸºäºä»Šæ—¥åŠ¨æ€ç”Ÿæˆæ—©é—´å†…å‚ã€‚è¦æ±‚ä½¿ç”¨æ˜¨æ™šé‚£ç§å¸¦å±‚çº§ã€åŠ ç²—ã€é€»è¾‘æ„Ÿæå¼ºçš„æ’ç‰ˆï¼š\n' + \
                       '1. âœ¨ **ã€ç»´ç‰¹æ ¹æ–¯å¦ Â· å“²å­¦æ€è¾¨ã€‘** (300å­—æ·±åº¦è§£è¯»ï¼Œéœ€å¸¦æœ‰å¼•ç”¨ç¬¦å· > )\n' + \
                       '2. ğŸ¤– **ã€AI ç§‘æŠ€å‰å“¨ã€‘** (ä»Šæ—¥å…¨çƒAIç•Œæœ€å€¼å¾—å…³æ³¨çš„3ä»¶å¤§äº‹)\n' + \
                       '3. ğŸ”¥ **ã€å°çº¢ä¹¦æµé‡å¯†ç ã€‘** (5ä¸ªçˆ†æ¬¾æ¡ˆä¾‹æ·±åº¦æ‹†è§£)\n' + \
                       'æ’ç‰ˆå¿…é¡»ä¸“ä¸šï¼Œé‡ç‚¹å†…å®¹åŠ ç²—ï¼Œæ®µè½æ¸…æ™°ã€‚'
              title = f'â˜€ï¸ æ—©å®‰Â·æ·±åº¦æƒ…æŠ¥ {date_str}'
          else:
              # --- ğŸŒ™ æ™šæŠ¥ï¼šé¦–å¸­å†…å‚ + è´¢ç»ä¸“çº¿ + ç ”å­¦è¿›åº¦ ---
              prompt = f'ä½ ç°åœ¨æ˜¯é¦–å¸­æ”¿ç»åˆ†æå¸ˆã€‚è¯·é’ˆå¯¹çƒ­ç‚¹ [{raw_news}] æ’°å†™æ·±åº¦å†…å‚ã€‚å¿…é¡»ä¸¥æ ¼éµå®ˆæ˜¨æ™šçš„è§†è§‰é€»è¾‘ï¼š\n' + \
                       '1. ğŸŒ **ã€å›½é™…è§†é‡ã€‘** (æ·±åº¦åˆ†æå¤§å›½åšå¼ˆ)\n' + \
                       '2. ğŸ‡¨ğŸ‡³ **ã€æ ¸å¿ƒè¦é—»ã€‘** (æ”¿ç­–ä¸ç¤¾ä¼šåŠ¨å‘)\n' + \
                       '3. ğŸ“ˆ **ã€è´¢ç»é£å‘æ ‡ Â· ä¸“çº¿ã€‘** (ç‹¬ç«‹æ¨¡å—ï¼šæ·±åº¦æ±‡æ€»ä»Šæ—¥å…¨çƒè´¢æŠ¥ã€æ±‡ç‡ã€å¤§å®—å•†å“åŠè¡Œä¸šæ³¢åŠ¨)\n' + \
                       '4. ğŸ¤– **ã€ä»Šæ—¥ AI å¤§äº‹è®°ã€‘** (æ±‡æ€»ä»Šæ—¥æŠ€æœ¯çªç ´ä¸äº§ä¸šåŠ¨æ€)\n' + \
                       '5. ğŸ¯ **ã€çŸ¥è¯†å†…åŒ– Â· ç ”å­¦è¿›åº¦è¡¨ã€‘** (Markdown è¡¨æ ¼ï¼šåºå·|æ ‡é¢˜|æ·±åº¦åˆ†æ|é‡‘å¥|è¿›åº¦âœ…)\n' + \
                       '6. ğŸ­ **ã€AI å“²å­¦ç‚¹è¯„ã€‘** (ä»¥äººæ–‡è§†è§’æ”¶å°¾)ã€‚\n' + \
                       'æ³¨æ„ï¼šä¸¥ç¦å‡ºç°ä»»ä½•ç‰¹å®šäººç‰©å§“åã€‚æ’ç‰ˆè¦æœ‰å‘¼å¸æ„Ÿï¼Œ500å­—ä»¥ä¸Šã€‚'
              title = f'ğŸŒ™ æ™šå®‰Â·é¦–å¸­å†…å‚ {date_str}'

          msg = get_ai_res(prompt)
          s_key = os.environ['SERVERCHAN_SENDKEY']
          params = urllib.parse.urlencode({'title': title, 'desp': msg})
          urllib.request.urlopen('https://sctapi.ftqq.com/' + s_key + '.send?' + params)
          "
