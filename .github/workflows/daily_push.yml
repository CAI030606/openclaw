name: OpenClaw Daily Report (Morning & Night)

on:
  workflow_dispatch:
  schedule:
    - cron: '0 1 * * *'   # 北京时间 09:00 (1+8)
    - cron: '30 13 * * *' # 北京时间 21:30 (13.5+8)

jobs:
  daily_job:
    runs-on: ubuntu-latest
    steps:
      - name: Run AI Tasks
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          SERVERCHAN_SENDKEY: ${{ secrets.SERVERCHAN_SENDKEY }}
        run: |
          python3 -c "
          import urllib.parse, urllib.request, json, os, datetime

          # 设置北京时间
          now_bj = datetime.datetime.utcnow() + datetime.timedelta(hours=8)
          hour = now_bj.hour

          def get_ai_res(prompt):
              data = json.dumps({'model': 'deepseek-chat', 'messages': [{'role': 'user', 'content': prompt}]}).encode()
              req = urllib.request.Request('https://api.deepseek.com/chat/completions', data=data, headers={'Content-Type': 'application/json', 'Authorization': f'Bearer {os.environ[\"OPENAI_API_KEY\"]}'})
              with urllib.request.urlopen(req) as f:
                  return json.loads(f.read().decode())['choices'][0]['message']['content']

          send_key = os.environ['SERVERCHAN_SENDKEY']

          # --- 早上 9 点逻辑 ---
          if 7 <= hour <= 11:
              txt1 = get_ai_res('精选一句《维特根斯坦传》语录并简短解读，80字内。')
              prompt_xhs = '作为小红书专家，总结3个今日爆款案例（标题+账号名+爆点），180字内。'
              txt2 = get_ai_res(prompt_xhs)
              title = '早安·深度简报'
              msg = f'【维特根斯坦】\n{txt1}\n\n【小红书深度情报】\n{txt2}'

          # --- 晚上 21 点逻辑 ---
          elif 20 <= hour <= 23:
              # 抓取新闻联播汇总 (使用 60s 免费接口)
              try:
                  with urllib.request.urlopen('https://api.vvhan.com/api/60s?type=json') as r:
                      news_data = json.loads(r.read().decode())
                      news_list = '\n'.join(news_data['data'][:10]) # 取前10条
                      title = '晚安·新闻汇总'
                      msg = f'【今日新闻联播精选】\n{news_list}\n\n【AI点评】\n' + get_ai_res(f'请用一句话点评今日新闻亮点：{news_list[:100]}')
              except:
                  title = '晚安·提醒'
                  msg = '今日新闻抓取失败，请检查接口。'
          
          else:
              # 手动触发时，同时发送两部分内容
              title = 'OpenClaw 手动测试'
              msg = '当前非定时时段，系统运行正常。'

          # 执行发送
          params = urllib.parse.urlencode({'title': title, 'desp': msg})
          urllib.request.urlopen(f'https://sctapi.ftqq.com/{send_key}.send?{params}')
          "
