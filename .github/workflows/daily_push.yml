name: OpenClaw Daily Report (Final Calibrated)

on:
  workflow_dispatch:
  schedule:
    - cron: '0 1 * * *'
    - cron: '30 13 * * *'

jobs:
  daily_job:
    runs-on: ubuntu-latest
    steps:
      - name: Run AI Tasks
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          SERVERCHAN_SENDKEY: ${{ secrets.SERVERCHAN_SENDKEY }}
        run: |
          python3 -c "
          import urllib.parse, urllib.request, json, os, datetime, re

          now_bj = datetime.datetime.utcnow() + datetime.timedelta(hours=8)
          hour = now_bj.hour
          date_str = now_bj.strftime('%m-%d')

          def get_ai_res(prompt):
              data = json.dumps({'model': 'deepseek-chat', 'messages': [{'role': 'user', 'content': prompt}]}).encode()
              req = urllib.request.Request('https://api.deepseek.com/chat/completions', data=data, headers={'Content-Type': 'application/json', 'Authorization': 'Bearer ' + os.environ['OPENAI_API_KEY']})
              with urllib.request.urlopen(req) as f:
                  return json.loads(f.read().decode())['choices'][0]['message']['content']

          # é€»è¾‘åˆ¤å®š
          if 5 <= hour <= 15:
              txt1 = get_ai_res('ç²¾é€‰ä¸€å¥ã€Šç»´ç‰¹æ ¹æ–¯å¦ä¼ ã€‹è¯­å½•å¹¶ç®€çŸ­è§£è¯»ï¼Œ300å­—å†…ã€‚')
              txt2 = get_ai_res('æ€»ç»“5ä¸ªä»Šæ—¥å°çº¢ä¹¦çˆ†æ¬¾æ¡ˆä¾‹ï¼Œ500å­—å†…ã€‚')
              title = 'â˜€ï¸ æ—©å®‰Â·æ·±åº¦ç®€æŠ¥ ' + date_str
              msg = '**ã€ç»´ç‰¹æ ¹æ–¯å¦ Â· æ¯æ—¥ä¸€è¯­ã€‘**\n> ' + txt1 + '\n\n**ã€ğŸ”¥ å°çº¢ä¹¦æ·±åº¦æƒ…æŠ¥ã€‘**\n' + txt2
          else:
              raw_news = 'å…¨çƒèµ„è®¯æ³¢åŠ¨ä¸­...'
              try:
                  req = urllib.request.Request('https://top.baidu.com/board?tab=realtime', headers={'User-Agent': 'Mozilla/5.0'})
                  with urllib.request.urlopen(req) as r:
                      titles = re.findall(r'\"word\":\"(.*?)\"', r.read().decode())
                      raw_news = 'ã€'.join(titles[:25])
              except: pass

              prompt = 'è¯·æ ¹æ®çƒ­ç‚¹ï¼š' + raw_news + ' æ’°å†™ä¸€ä»½ä¸“ä¸šå†…å‚ç®€æŠ¥ã€‚åŒ…å«ã€å›½é™…è§†é‡ã€‘ã€ã€æ ¸å¿ƒè¦é—»ã€‘ã€ã€ç»æµä¸ç¤¾ä¼šã€‘ã€ã€ä»Šæ—¥å°ç»“ã€‘å’Œã€AIå“²å­¦ç‚¹è¯„ã€‘ã€‚è¦æ±‚å¤šç”¨ç²—ä½“ï¼Œæ’ç‰ˆç²¾ç¾ï¼Œ500å­—å·¦å³ã€‚'
              title = 'ğŸŒ™ æ™šå®‰Â·æ·±åº¦æ±‡æŠ¥ ' + date_str
              msg = get_ai_res(prompt)

          # å‘é€
          s_key = os.environ['SERVERCHAN_SENDKEY']
          params = urllib.parse.urlencode({'title': title, 'desp': msg})
          urllib.request.urlopen('https://sctapi.ftqq.com/' + s_key + '.send?' + params)
          "
