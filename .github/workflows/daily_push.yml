name: OpenClaw Daily Report (Final Calibrated)

on:
  workflow_dispatch:
  schedule:
    - cron: '0 1 * * *'
    - cron: '30 13 * * *'

jobs:
  daily_job:
    runs-on: ubuntu-latest
    steps:
      - name: Run AI Tasks
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          SERVERCHAN_SENDKEY: ${{ secrets.SERVERCHAN_SENDKEY }}
        run: |
          python3 -c "
          import urllib.parse, urllib.request, json, os, datetime, re

          now_bj = datetime.datetime.utcnow() + datetime.timedelta(hours=8)
          hour = now_bj.hour
          date_str = now_bj.strftime('%m-%d')

          def get_ai_res(prompt):
              data = json.dumps({'model': 'deepseek-chat', 'messages': [{'role': 'user', 'content': prompt}]}).encode()
              req = urllib.request.Request('https://api.deepseek.com/chat/completions', data=data, headers={'Content-Type': 'application/json', 'Authorization': 'Bearer ' + os.environ['OPENAI_API_KEY']})
              with urllib.request.urlopen(req) as f:
                  return json.loads(f.read().decode())['choices'][0]['message']['content']

          # --- â˜€ï¸ é€»è¾‘åˆ¤å®šï¼šæ—©å®‰ç®€æŠ¥ ---
          if 5 <= hour <= 15:
              txt1 = get_ai_res('ç²¾é€‰ä¸€å¥ã€Šç»´ç‰¹æ ¹æ–¯å¦ä¼ ã€‹è¯­å½•å¹¶è¿›è¡Œæ·±åº¦å“²å­¦è§£è¯»ï¼Œè¦æ±‚é€»è¾‘ä¸¥å¯†ï¼Œ300å­—å†…ã€‚')
              txt2 = get_ai_res('è¯·æœé›†æˆ–æ€»ç»“ä»Šæ—¥5ä¸ªå°çº¢ä¹¦çˆ†æ¬¾æ¡ˆä¾‹ï¼ˆå«æ ‡é¢˜ã€è´¦å·ç±»å‹ã€çˆ†ç‚¹åˆ†æï¼‰ï¼Œæ’ç‰ˆç²¾ç¾ä¸”å¸¦Emojiï¼Œ500å­—å†…ã€‚')
              title = 'â˜€ï¸ æ—©å®‰Â·æ·±åº¦ç®€æŠ¥ ' + date_str
              msg = 'âœ¨ **ã€ç»´ç‰¹æ ¹æ–¯å¦ Â· æ¯æ—¥ä¸€è¯­ã€‘**\n> ' + txt1 + '\n\nğŸ”¥ **ã€å°çº¢ä¹¦æ·±åº¦æƒ…æŠ¥ Â· çˆ†æ¬¾æ‹†è§£ã€‘**\n' + txt2
          
          # --- ğŸŒ™ é€»è¾‘åˆ¤å®šï¼šæ™šå®‰æ±‡æŠ¥ ---
          else:
              raw_news = 'å…¨çƒèµ„è®¯æ³¢åŠ¨ä¸­...'
              try:
                  req = urllib.request.Request('https://top.baidu.com/board?tab=realtime', headers={'User-Agent': 'Mozilla/5.0'})
                  with urllib.request.urlopen(req) as r:
                      titles = re.findall(r'\"word\":\"(.*?)\"', r.read().decode())
                      raw_news = 'ã€'.join(titles[:25])
              except: pass

              prompt = 'ä½ ç°åœ¨æ˜¯é¦–å¸­åˆ†æå¸ˆã€‚è¯·æ ¹æ®çƒ­ç‚¹ï¼š' + raw_news + ' æ’°å†™ä¸€ä»½ä¸“ä¸šå†…å‚ç®€æŠ¥ã€‚è¦æ±‚ä¸¥æ ¼åŒ…å«ä»¥ä¸‹æ¨¡å—ï¼š\n' + \
                       '1. ğŸŒ **ã€å›½é™…è§†é‡ã€‘**ï¼ˆæ·±åº¦æ¦‚æ‹¬å¤§å›½åšå¼ˆæˆ–å›½é™…è¶‹åŠ¿ï¼‰\n' + \
                       '2. ğŸ‡¨ğŸ‡³ **ã€æ ¸å¿ƒè¦é—»ã€‘**ï¼ˆå›½å†…æ”¿ç­–æˆ–ç¤¾ä¼šé‡å¤§åŠ¨å‘ï¼‰\n' + \
                       '3. ğŸ“‰ **ã€ç»æµä¸ç¤¾ä¼šã€‘**ï¼ˆæ¶ˆè´¹ã€ç§‘æŠ€æˆ–æ°‘ç”Ÿçƒ­ç‚¹ï¼‰\n' + \
                       '4. ğŸ¯ **ã€ä»Šæ—¥å°ç»“ã€‘**ï¼ˆç”¨ç²¾ç‚¼çš„è¯­è¨€æ€»ç»“ä»Šæ—¥ç¤¾ä¼šæƒ…ç»ªæˆ–æ ¸å¿ƒæ¼”å˜è¶‹åŠ¿ï¼‰\n' + \
                       '5. ğŸ­ **ã€AI å“²å­¦ç‚¹è¯„ã€‘**ï¼ˆä»ç»´ç‰¹æ ¹æ–¯å¦æˆ–å­˜åœ¨ä¸»ä¹‰è§†è§’è¿›è¡Œå†·å³»ä¸”äººæ–‡çš„æ”¶å°¾ï¼‰ã€‚\n' + \
                       'æ’ç‰ˆè¦æ±‚ï¼šå¤šç”¨**åŠ ç²—**çªå‡ºå…³é”®è¯ï¼Œé€‚å½“å¢åŠ åˆ†å‰²çº¿æˆ–Emojiã€‚å­—æ•°500å­—å·¦å³ã€‚'
              title = 'ğŸŒ™ æ™šå®‰Â·æ·±åº¦æ±‡æŠ¥ ' + date_str
              msg = get_ai_res(prompt)

          # å‘é€
          s_key = os.environ['SERVERCHAN_SENDKEY']
          params = urllib.parse.urlencode({'title': title, 'desp': msg})
          urllib.request.urlopen('https://sctapi.ftqq.com/' + s_key + '.send?' + params)
          "
