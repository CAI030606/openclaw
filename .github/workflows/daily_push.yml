name: OpenClaw Daily Report (Final Calibrated)

on:
  workflow_dispatch:
  schedule:
    - cron: '0 1 * * *'   # ç›®æ ‡åŒ—äº¬æ—¶é—´ 09:00
    - cron: '30 13 * * *' # ç›®æ ‡åŒ—äº¬æ—¶é—´ 21:30

jobs:
  daily_job:
    runs-on: ubuntu-latest
    steps:
      - name: Run AI Tasks
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          SERVERCHAN_SENDKEY: ${{ secrets.SERVERCHAN_SENDKEY }}
        run: |
          python3 -c "
          import urllib.parse, urllib.request, json, os, datetime, re

          # 1. å¼ºåˆ¶è·å–åŒ—äº¬æ—¶é—´ (ä¸ç®¡GitHubå»¶è¿Ÿå¤šä¹…ï¼Œéƒ½ä»¥åŒ—äº¬æ—¶é—´ä¸ºå‡†)
          now_bj = datetime.datetime.utcnow() + datetime.timedelta(hours=8)
          hour = now_bj.hour
          date_str = now_bj.strftime('%m-%d')

          def get_ai_res(prompt):
              data = json.dumps({'model': 'deepseek-chat', 'messages': [{'role': 'user', 'content': prompt}]}).encode()
              req = urllib.request.Request('https://api.deepseek.com/chat/completions', data=data, headers={'Content-Type': 'application/json', 'Authorization': f'Bearer {os.environ[\"OPENAI_API_KEY\"]}'})
              with urllib.request.urlopen(req) as f:
                  return json.loads(f.read().decode())['choices'][0]['message']['content']

          # 2. æ‰©å®¹åˆ¤æ–­é€»è¾‘ï¼šåªè¦åœ¨åŒ—äº¬æ—¶é—´ 05:00 - 15:00 ä¹‹é—´è¿è¡Œï¼Œå°±å‘æ—©æŠ¥
          if 5 <= hour <= 15:
              txt1 = get_ai_res('ç²¾é€‰ä¸€å¥ã€Šç»´ç‰¹æ ¹æ–¯å¦ä¼ ã€‹è¯­å½•å¹¶ç®€çŸ­è§£è¯»ï¼Œ200å­—å†…ã€‚')
              txt2 = get_ai_res('ä½œä¸ºå°çº¢ä¹¦ä¸“å®¶ï¼Œæ€»ç»“3ä¸ªä»Šæ—¥çˆ†æ¬¾æ¡ˆä¾‹ï¼ˆæ ‡é¢˜+è´¦å·å+çˆ†ç‚¹ï¼‰ï¼Œ500å­—å†…ã€‚')
              title = f'â˜€ï¸ æ—©å®‰Â·æ·±åº¦ç®€æŠ¥ {date_str}'
              msg = f'**ã€ç»´ç‰¹æ ¹æ–¯å¦ Â· æ¯æ—¥ä¸€è¯­ã€‘**\n> {txt1}\n\n**ã€ğŸ”¥ å°çº¢ä¹¦æ·±åº¦æƒ…æŠ¥ã€‘**\n{txt2}'

          # 3. åªè¦åœ¨åŒ—äº¬æ—¶é—´ 15:00 - 04:00 ä¹‹é—´è¿è¡Œï¼Œå°±å‘æ™šæŠ¥
          else:
              raw_news = ''
              try:
                  req = urllib.request.Request('https://top.baidu.com/board?tab=realtime', headers={'User-Agent': 'Mozilla/5.0'})
                  with urllib.request.urlopen(req) as r:
                      content = r.read().decode()
                      titles = re.findall(r'\"word\":\"(.*?)\"', content)
                      raw_news = 'ã€'.join(titles[:25])
              except:
                  raw_news = 'å…¨çƒèµ„è®¯æ­£åœ¨é«˜é¢‘æ³¢åŠ¨ä¸­...'

              prompt_news = f'''
              ä½ ç°åœ¨æ˜¯ OpenClaw é¦–å¸­æ”¿ç»è§‚å¯Ÿå‘˜ã€‚è¯·æ ¹æ®ä»Šæ—¥çƒ­ç‚¹ï¼š{{raw_news}}
              æ’°å†™ä¸€ä»½å¯¹æ ‡ä¸“ä¸šå†…å‚çš„æ–°é—»ç®€æŠ¥ã€‚æ ¼å¼å‚è€ƒï¼š
              ğŸ“… **AI ç®€æŠ¥ï¼šæ–°é—»è”æ’­ç²¾å {date_str}**
              **1. ğŸŒ ã€å›½é™…è§†é‡ã€‘** (å«è¿è¥è§†è§’/æ·±åº¦è§£è¯»)
              **2. ğŸ‡¨ğŸ‡³ ã€æ ¸å¿ƒè¦é—»ã€‘** (æ€»ç»“å›½å†…é‡å¤§åŠ¨å‘)
              **3. ğŸ“‰ ã€ç»æµä¸ç¤¾ä¼šã€‘** (æ’ç‰ˆç¾è§‚ï¼Œé‡ç‚¹åŠ ç²—)
              **4. ğŸ­ ã€AI å“²å­¦ç‚¹è¯„ã€‘** (äººæ–‡å…³æ€€è§†è§’)
              å­—æ•°500å­—å·¦å³ã€‚
              '''
              formatted_news = get_ai_res(prompt_news)
              title = f'ğŸŒ™ æ™šå®‰Â·æ·±åº¦æ±‡æŠ¥ {date_str}'
              msg = formatted_news

          # 4. æ‰§è¡Œå‘é€
          params = urllib.parse.urlencode({'title': title, 'desp': msg})
          urllib.request.urlopen(f'https://sctapi.ftqq.com/{{os.environ[\"SERVERCHAN_SENDKEY\"]}}.send?{{params}}')
          "
