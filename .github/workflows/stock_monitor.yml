name: OpenClaw Stock Radar Pro (Smart Timing)

on:
  workflow_dispatch:
  schedule:
    - cron: '*/30 * * * *'

jobs:
  check_stocks:
    runs-on: ubuntu-latest
    steps:
      - name: Install dependencies
        run: pip install yfinance pandas pytz

      - name: Run Stock Check
        env:
          SERVERCHAN_SENDKEY: ${{ secrets.SERVERCHAN_SENDKEY }}
          MY_STOCKS: ${{ secrets.MY_STOCKS }}
          STOCK_STRATEGY: ${{ secrets.STOCK_STRATEGY }}
        run: |
          python3 -c "
          import yfinance as yf
          import os, urllib.parse, urllib.request
          from datetime import datetime
          import pytz

          beijing_tz = pytz.timezone('Asia/Shanghai')
          now_bj = datetime.now(beijing_tz)
          hour_min = now_bj.strftime('%H:%M')
          is_weekday = now_bj.weekday() < 5

          stocks = os.environ['MY_STOCKS'].replace(' ', '').split(',')
          strategies = os.environ['STOCK_STRATEGY'].strip().split('\n')
          send_key = os.environ['SERVERCHAN_SENDKEY']
          alerts = []

          def is_market_open(symbol):
              s = symbol.lower()
              if any(ext in s for ext in ['.ss', '.sz', '.hk']):
                  return '09:15' <= hour_min <= '16:05'
              else:
                  return hour_min >= '21:00' or hour_min <= '05:00'

          if not is_weekday:
              print('Weekend, market closed.')
              exit()

          for i, symbol in enumerate(stocks):
              if not is_market_open(symbol):
                  print(f'{symbol} out of market hours, skipping.')
                  continue

              try:
                  ticker = yf.Ticker(symbol)
                  hist = ticker.history(period='5d')
                  if len(hist) < 2: continue

                  current_price = hist['Close'].iloc[-1]
                  prev_close = hist['Close'].iloc[-2]
                  
                  full_year = ticker.history(period='1y')['Close']
                  ma199 = full_year.rolling(window=199).mean().iloc[-1] if len(full_year) >= 199 else None
                  
                  buy_trigger, sell_trigger = map(float, strategies[i].split('|'))
                  change = current_price / prev_close
                  
                  if change <= buy_trigger:
                      alerts.append(f'ðŸ“‰ å®žæ—¶å¤§è·Œ | {symbol}\nçŽ°ä»·: {current_price:.2f} (è·Œ{(1-change)*100:.2f}%)')
                  if change >= sell_trigger:
                      alerts.append(f'ðŸ“ˆ å®žæ—¶å¤§æ¶¨ | {symbol}\nçŽ°ä»·: {current_price:.2f} (æ¶¨{(change-1)*100:.2f}%)')
                  if ma199 and current_price < ma199:
                      alerts.append(f'ðŸ›¡ï¸ MA199é¢„è­¦ | {symbol}\nçŽ°ä»·: {current_price:.2f} è·Œç ´MA199({ma199:.2f})')
              except Exception as e:
                  print(f'Error on {symbol}: {e}')

          if alerts:
              full_msg = '\n\n'.join(alerts)
              params = urllib.parse.urlencode({'title': 'ðŸ”” OpenClaw å®žæ—¶é¢„è­¦', 'desp': full_msg})
              urllib.request.urlopen(f'https://sctapi.ftqq.com/{send_key}.send?{params}')
          "
