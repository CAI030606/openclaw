name: OpenClaw Stock Radar Auto

on:
  workflow_dispatch:
  schedule:
    # åŒ—äº¬æ—¶é—´å‘¨ä¸€è‡³å‘¨äº”ï¼Œ09:30 - 16:00ï¼Œæ¯ 30 åˆ†é’Ÿè¿è¡Œä¸€æ¬¡
    # UTCæ—¶é—´ä¸º 01:30 - 08:00
    - cron: '30/30 1-8 * * 1-5'

jobs:
  check_stocks:
    runs-on: ubuntu-latest
    steps:
      - name: Install dependencies
        run: pip install yfinance pandas

      - name: Auto Price & MA199 Check
        env:
          SERVERCHAN_SENDKEY: ${{ secrets.SERVERCHAN_SENDKEY }}
          MY_STOCKS: ${{ secrets.MY_STOCKS }}
          STOCK_STRATEGY: ${{ secrets.STOCK_STRATEGY }}
        run: |
          python3 -c "
          import yfinance as yf
          import os, urllib.parse, urllib.request
          import pandas as pd

          stocks = os.environ['MY_STOCKS'].split(',')
          strategies = os.environ['STOCK_STRATEGY'].strip().split('\n')
          send_key = os.environ['SERVERCHAN_SENDKEY']
          alerts = []

          for i, symbol in enumerate(stocks):
              try:
                  ticker = yf.Ticker(symbol)
                  # è·å– 1 å¹´å†å²æ•°æ®ç”¨äºè®¡ç®— MA199 å’ŒåŸºå‡†ä»·
                  hist = ticker.history(period='1y')
                  
                  if len(hist) < 2:
                      continue

                  current_price = hist['Close'].iloc[-1]
                  prev_close = hist['Close'].iloc[-2] # è‡ªåŠ¨è·å–å‰ä¸€äº¤æ˜“æ—¥æ”¶ç›˜ä»·
                  ma199 = hist['Close'].rolling(window=199).mean().iloc[-1]
                  
                  # è§£æç­–ç•¥ï¼šåªè¯»æ¯”ä¾‹
                  buy_trigger_pct, sell_trigger_pct = map(float, strategies[i].split('|'))
                  
                  # è®¡ç®—ç›¸å¯¹äºæ˜¨æ”¶çš„å®æ—¶æ¶¨è·Œå¹…
                  realtime_change = current_price / prev_close
                  
                  # é¢„è­¦é€»è¾‘
                  if realtime_change <= buy_trigger_pct:
                      alerts.append(f'ğŸ“‰ å®æ—¶å¤§è·Œ | {symbol}\nç°ä»·: {current_price:.2f} (è¾ƒæ˜¨æ”¶è·Œ{(1-realtime_change)*100:.1f}%)')
                  
                  if realtime_change >= sell_trigger_pct:
                      alerts.append(f'ğŸ“ˆ å®æ—¶å¤§æ¶¨ | {symbol}\nç°ä»·: {current_price:.2f} (è¾ƒæ˜¨æ”¶æ¶¨{(realtime_change-1)*100:.1f}%)')

                  if current_price < ma199:
                      alerts.append(f'ğŸ›¡ï¸ MA199é¢„è­¦ | {symbol}\nç°ä»·: {current_price:.2f} å·²è·Œç ´MA199çº¿({ma199:.2f})')
                      
              except Exception as e:
                  print(f'Error on {symbol}: {e}')

          if alerts:
              full_msg = '\n\n'.join(alerts)
              params = urllib.parse.urlencode({'title': 'ğŸ”” OpenClaw è‚¡ç¥¨å¼‚åŠ¨', 'desp': full_msg})
              urllib.request.urlopen(f'https://sctapi.ftqq.com/{send_key}.send?{params}')
          "
