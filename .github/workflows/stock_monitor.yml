name: OpenClaw Stock Radar Pro (Smart Timing)

on:
  workflow_dispatch:
  schedule:
    # æ‰©å¤§è¿è¡Œæ—¶é—´çª—å£ï¼Œè¦†ç›–ç¾è‚¡å’Œ A è‚¡ï¼ˆåŒ—äº¬æ—¶é—´ 09:00 - 05:00ï¼‰
    - cron: '*/30 * * * *'

jobs:
  check_stocks:
    runs-on: ubuntu-latest
    steps:
      - name: Install dependencies
        run: pip install yfinance pandas pytz

      - name: Smart Market Timing Check
        env:
          SERVERCHAN_SENDKEY: ${{ secrets.SERVERCHAN_SENDKEY }}
          MY_STOCKS: ${{ secrets.MY_STOCKS }}
          STOCK_STRATEGY: ${{ secrets.STOCK_STRATEGY }}
        run: |
          python3 -c "
          import yfinance as yf
          import os, urllib.parse, urllib.request
          from datetime import datetime
          import pytz

          # è®¾ç½®æ—¶åŒº
          beijing_tz = pytz.timezone('Asia/Shanghai')
          now_bj = datetime.now(beijing_tz)
          hour_min = now_bj.strftime('%H:%M')
          is_weekday = now_bj.weekday() < 5

          stocks = os.environ['MY_STOCKS'].split(',')
          strategies = os.environ['STOCK_STRATEGY'].strip().split('\n')
          send_key = os.environ['SERVERCHAN_SENDKEY']
          alerts = []

          def is_market_open(symbol):
              # A è‚¡/æ¸¯è‚¡æ—¶æ®µ: 09:15 - 16:00
              if '.ss' in symbol or '.sz' in symbol or '.hk' in symbol:
                  return '09:15' <= hour_min <= '16:00'
              # ç¾è‚¡æ—¶æ®µ (å†¬ä»¤æ—¶): 22:30 - 05:00 (+1å¤©)
              # ä¸ºäº†ç®€åŒ–ï¼Œåˆ¤æ–­åœ¨ 22:30 ä¹‹åæˆ– 05:00 ä¹‹å‰
              else:
                  return hour_min >= '22:30' or hour_min <= '05:00'

          if not is_weekday:
              print('å‘¨æœ«ä¼‘å¸‚')
              exit()

          for i, symbol in enumerate(stocks):
              if not is_market_open(symbol):
                  print(f'{symbol} æ‰€åœ¨å¸‚åœºå·²æ”¶ç›˜ï¼Œè·³è¿‡ã€‚')
                  continue

              try:
                  ticker = yf.Ticker(symbol)
                  hist = ticker.history(period='2d')
                  if len(hist) < 2: continue

                  current_price = hist['Close'].iloc[-1]
                  prev_close = hist['Close'].iloc[-2]
                  ma199 = ticker.history(period='1y')['Close'].rolling(window=199).mean().iloc[-1]
                  
                  buy_trigger_pct, sell_trigger_pct = map(float, strategies[i].split('|'))
                  realtime_change = current_price / prev_close
                  
                  if realtime_change <= buy_trigger_pct:
                      alerts.append(f'ğŸ“‰ å®æ—¶å¤§è·Œ | {symbol}\nç°ä»·: {current_price:.2f} (è¾ƒæ˜¨æ”¶è·Œ{(1-realtime_change)*100:.1f}%)')
                  if realtime_change >= sell_trigger_pct:
                      alerts.append(f'ğŸ“ˆ å®æ—¶å¤§æ¶¨ | {symbol}\nç°ä»·: {current_price:.2f} (è¾ƒæ˜¨æ”¶æ¶¨{(realtime_change-1)*100:.1f}%)')
                  if current_price < ma199:
                      alerts.append(f'ğŸ›¡ï¸ MA199é¢„è­¦ | {symbol}\nç°ä»·: {current_price:.2f} è·Œç ´MA199({ma199:.2f})')
              except Exception as e:
                  print(f'Error on {symbol}: {e}')

          if alerts:
              full_msg = '\n\n'.join(alerts)
              params = urllib.parse.urlencode({'title': 'ğŸ”” OpenClaw å®æ—¶é¢„è­¦', 'desp': full_msg})
              urllib.request.urlopen(f'https://sctapi.ftqq.com/{send_key}.send?{params}')
          "
