          import yfinance as yf
          import os, urllib.parse, urllib.request
          from datetime import datetime
          import pytz

          # è®¾ç½®æ—¶åŒº
          beijing_tz = pytz.timezone('Asia/Shanghai')
          now_bj = datetime.now(beijing_tz)
          hour_min = now_bj.strftime('%H:%M')
          is_weekday = now_bj.weekday() < 5

          # ç»Ÿä¸€è½¬ä¸ºå°å†™å¤„ç†ï¼Œé˜²æ­¢å¤§å°å†™å‘
          stocks = os.environ['MY_STOCKS'].replace(' ', '').split(',')
          strategies = os.environ['STOCK_STRATEGY'].strip().split('\n')
          send_key = os.environ['SERVERCHAN_SENDKEY']
          alerts = []

          def is_market_open(symbol):
              s = symbol.lower()
              # A è‚¡/æ¸¯è‚¡æ—¶æ®µ (å«åŽç¼€åˆ¤å®šæ ¡å‡†)
              if any(ext in s for ext in ['.ss', '.sz', '.hk']):
                  # æ¸¯è‚¡ä¸Ž A è‚¡é€šç”¨å¤§è‡´æ—¶æ®µ
                  return '09:15' <= hour_min <= '16:05'
              # ç¾Žè‚¡æ—¶æ®µ (å…¼å®¹å¤ä»¤æ—¶/å†¬ä»¤æ—¶çš„å¤§çª—å£)
              else:
                  return hour_min >= '21:00' or hour_min <= '05:00'

          if not is_weekday:
              print('å‘¨æœ«ä¼‘å¸‚')
              exit()

          for i, symbol in enumerate(stocks):
              # é€»è¾‘ä¿®æ­£ï¼šå…ˆç»Ÿä¸€è½¬å°å†™å†åˆ¤å®š
              if not is_market_open(symbol):
                  print(f'{symbol} æ‰€åœ¨å¸‚åœºæœªåœ¨ç›‘æŽ§æ—¶æ®µï¼Œè·³è¿‡ã€‚')
                  continue

              try:
                  ticker = yf.Ticker(symbol)
                  # æé«˜å®¹é”™ï¼Œå– 5 å¤©æ•°æ®ç¡®ä¿èƒ½æ‹¿åˆ°å‰ä¸€å¤©çš„æ”¶ç›˜ä»·
                  hist = ticker.history(period='5d')
                  if len(hist) < 2: 
                      print(f'{symbol} æ•°æ®é‡ä¸è¶³')
                      continue

                  current_price = hist['Close'].iloc[-1]
                  prev_close = hist['Close'].iloc[-2]
                  
                  # è®¡ç®— MA199 (ä½¿ç”¨è¿‘ 1 å¹´æ•°æ®)
                  full_year_data = ticker.history(period='1y')['Close']
                  if len(full_year_data) >= 199:
                      ma199 = full_year_data.rolling(window=199).mean().iloc[-1]
                  else:
                      ma199 = None
                  
                  buy_trigger_pct, sell_trigger_pct = map(float, strategies[i].split('|'))
                  realtime_change = current_price / prev_close
                  
                  # é¢„è­¦é€»è¾‘
                  if realtime_change <= buy_trigger_pct:
                      alerts.append(f'ðŸ“‰ å®žæ—¶å¤§è·Œ | {symbol}\nçŽ°ä»·: {current_price:.2f} (è¾ƒæ˜¨æ”¶è·Œ{(1-realtime_change)*100:.2f}%)')
                  if realtime_change >= sell_trigger_pct:
                      alerts.append(f'ðŸ“ˆ å®žæ—¶å¤§æ¶¨ | {symbol}\nçŽ°ä»·: {current_price:.2f} (è¾ƒæ˜¨æ”¶æ¶¨{(realtime_change-1)*100:.2f}%)')
                  if ma199 and current_price < ma199:
                      alerts.append(f'ðŸ›¡ï¸ MA199é¢„è­¦ | {symbol}\nçŽ°ä»·: {current_price:.2f} è·Œç ´MA199({ma199:.2f})')
                      
              except Exception as e:
                  print(f'Error on {symbol}: {e}')

          if alerts:
              full_msg = '\n\n'.join(alerts)
              params = urllib.parse.urlencode({'title': 'ðŸ”” OpenClaw å®žæ—¶é¢„è­¦', 'desp': full_msg})
              # ä¿®æ­£æ‹¼æŽ¥æ–¹å¼
              url = f'https://sctapi.ftqq.com/{send_key}.send?{params}'
              urllib.request.urlopen(url)
